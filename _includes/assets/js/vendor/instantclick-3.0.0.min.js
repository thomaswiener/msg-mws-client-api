/* InstantClick 3.0 | (C) 2014 Alexandre Dieulot | http://instantclick.io/license.html */
var InstantClick=function(a,b){function w(a){var b=a.indexOf("#");return 0>b?a:a.substr(0,b)}function x(a){for(;"A"!=a.nodeName;)a=a.parentNode;return a}function y(a){do{if(!a.hasAttribute)break;if(a.hasAttribute("data-instant"))return!1;if(a.hasAttribute("data-no-instant"))return!0}while(a=a.parentNode);return!1}function z(a){do{if(!a.hasAttribute)break;if(a.hasAttribute("data-no-instant"))return!1;if(a.hasAttribute("data-instant"))return!0}while(a=a.parentNode);return!1}function A(a,b){for(var c=0;c<v[a].length;c++)v[a][c](b)}function B(b,c,d,f){if(a.title=b,a.documentElement.replaceChild(c,a.body),d){history.pushState(null,null,d);var g=d.indexOf("#"),h=g>-1&&a.getElementById(d.substr(g+1)),i=0;if(h)for(;h.offsetParent;)i+=h.offsetTop,h=h.offsetParent;scrollTo(0,i),e=w(d)}else scrollTo(0,f);J(),M.done(),A("change",!1)}function C(){p=!1,q=!1}function D(a){K(x(a.target).href)}function E(a){var b=x(a.target);b.addEventListener("mouseout",H),u?(f=b.href,g=setTimeout(K,u)):K(b.href)}function F(a){var b=x(a.target);t?b.removeEventListener("mousedown",D):b.removeEventListener("mouseover",E),K(b.href)}function G(a){a.which>1||a.metaKey||a.ctrlKey||(a.preventDefault(),L(x(a.target).href))}function H(){return g?(clearTimeout(g),g=!1,void 0):(p&&!q&&(i.abort(),C()),void 0)}function I(){if(!(i.readyState<4)&&0!=i.status){if(o.ready=+new Date-o.start,A("receive"),i.getResponseHeader("Content-Type").match(/\/(x|ht|xht)ml/)){var b=a.implementation.createHTMLDocument("");b.documentElement.innerHTML=i.responseText,l=b.title,n=b.body;var c=w(k);h[c]={body:n,title:l,scrollY:c in h?h[c].scrollY:0};for(var f,g,d=b.head.children,e=0,j=d.length-1;j>=0;j--)if(f=d[j],f.hasAttribute("data-instant-track")){g=f.getAttribute("href")||f.getAttribute("src")||f.innerHTML;for(var p=r.length-1;p>=0;p--)r[p]==g&&e++}e!=r.length&&(m=!0)}else m=!0;q&&(q=!1,L(k))}}function J(c){for(var f,d=a.getElementsByTagName("a"),g=b.protocol+"//"+b.host,h=d.length-1;h>=0;h--)f=d[h],f.target||f.hasAttribute("download")||0!=f.href.indexOf(g+"/")||f.href.indexOf("#")>-1&&w(f.href)==e||(s?!z(f):y(f))||(f.addEventListener("touchstart",F),t?f.addEventListener("mousedown",D):f.addEventListener("mouseover",E),f.addEventListener("click",G));if(!c){var k,l,m,n,i=a.body.getElementsByTagName("script");for(h=0,j=i.length;j>h;h++)k=i[h],k.hasAttribute("data-no-instant")||(l=a.createElement("script"),k.src&&(l.src=k.src),k.innerHTML&&(l.innerHTML=k.innerHTML),m=k.parentNode,n=k.nextSibling,m.removeChild(k),m.insertBefore(l,n))}}function K(a){!t&&"display"in o&&+new Date-(o.start+o.display)<100||(g&&(clearTimeout(g),g=!1),a||(a=f),(!p||a!=k&&!q)&&(p=!0,q=!1,k=a,n=!1,m=!1,o={start:+new Date},A("fetch"),i.open("GET",a),i.send()))}function L(a){return"display"in o||(o.display=+new Date-o.start),g?k&&k!=a?(b.href=a,void 0):(K(a),M.start(0,!0),A("wait"),q=!0,void 0):!p||q?(b.href=a,void 0):m?(b.href=k,void 0):n?(h[e].scrollY=pageYOffset,C(),B(l,n,k),void 0):(M.start(0,!0),A("wait"),q=!0,void 0)}function O(){if(!e){if(!N)return A("change",!0),void 0;for(var c=arguments.length-1;c>=0;c--){var d=arguments[c];d===!0?s=!0:"mousedown"==d?t=!0:"number"==typeof d&&(u=d)}e=w(b.href),h[e]={body:a.body,title:a.title,scrollY:pageYOffset};for(var g,j,f=a.head.children,c=f.length-1;c>=0;c--)g=f[c],g.hasAttribute("data-instant-track")&&(j=g.getAttribute("href")||g.getAttribute("src")||g.innerHTML,r.push(j));i=new XMLHttpRequest,i.addEventListener("readystatechange",I),J(!0),M.init(),A("change",!0),addEventListener("popstate",function(){var a=w(b.href);if(a!=e){if(!(a in h))return b.href=b.href,void 0;h[e].scrollY=pageYOffset,e=a,B(h[a].title,h[a].body,!1,h[a].scrollY)}})}}function P(a,b){v[a].push(b)}var e,f,g,i,s,t,u,c=navigator.userAgent,d="createTouch"in a,h={},k=!1,l=!1,m=!1,n=!1,o={},p=!1,q=!1,r=[],v={fetch:[],receive:[],wait:[],change:[]},M=function(){function h(){b=a.createElement("div"),b.id="instantclick",c=a.createElement("div"),c.id="instantclick-bar",c.className="instantclick-bar",b.appendChild(c);var f=["Webkit","Moz","O"];if(e="transform",!(e in c.style))for(var g=0;3>g;g++)f[g]+"Transform"in c.style&&(e=f[g]+"Transform");var h="transition";if(!(h in c.style))for(var g=0;3>g;g++)f[g]+"Transition"in c.style&&(h="-"+f[g].toLowerCase()+"-"+h);var i=a.createElement("style");i.innerHTML="#instantclick{position:"+(d?"absolute":"fixed")+";top:0;left:0;width:100%;pointer-events:none;z-index:2147483647;"+h+":opacity .25s .1s}"+".instantclick-bar{background:#29d;width:100%;margin-left:-100%;height:2px;"+h+":all .25s}",a.head.appendChild(i),d&&(n(),addEventListener("resize",n),addEventListener("scroll",n))}function i(c,d){f=c,a.getElementById(b.id)&&a.body.removeChild(b),b.style.opacity="1",a.getElementById(b.id)&&a.body.removeChild(b),l(),d&&setTimeout(j,0),clearTimeout(g),g=setTimeout(k,500)}function j(){f=10,l()}function k(){f+=1+2*Math.random(),f>=98?f=98:g=setTimeout(k,500),l()}function l(){c.style[e]="translate("+f+"%)",a.getElementById(b.id)||a.body.appendChild(b)}function m(){return a.getElementById(b.id)?(clearTimeout(g),f=100,l(),b.style.opacity="0",void 0):(i(100==f?0:f),setTimeout(m,0),void 0)}function n(){b.style.left=pageXOffset+"px",b.style.width=innerWidth+"px",b.style.top=pageYOffset+"px";var a=2*(innerWidth/screen[90==Math.abs(orientation)?"height":"width"]);b.style[e]="scaleY("+a+")"}var b,c,e,f,g;return{init:h,start:i,done:m}}(),N="pushState"in history&&(!c.match("Android")||c.match("Chrome/"))&&"file:"!=b.protocol;return{supported:N,init:O,on:P,instantanize:J}}(document,location);
